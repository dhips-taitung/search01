<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>å®¶é•·è³‡æ–™æŸ¥è©¢ç³»çµ±</title>

<script>

// ğŸ”¹ æ›æˆä½ çš„ Web App URL
var GAS_URL = "https://script.google.com/macros/s/AKfycbwwPt4QXfhij0Vc2xnUXXhyeG_EHfjIO8CuvG-6wnCxcMztlCji8ONatc5JCsU6NkYv/exec";

// =======================
// é©—è­‰ç¢¼è™•ç†
// =======================
function getAuthCode(){
  let code = sessionStorage.getItem("authCode");
  if(!code){
    code = prompt("è«‹è¼¸å…¥é©—è­‰ç¢¼ï¼š");
    if(!code) return null;
    sessionStorage.setItem("authCode",code);
  }
  return code;
}

// =======================
// æ—¥æœŸæ ¼å¼åŒ–
// =======================
Date.prototype.format = function (fmt) {
    var o = {
        "M+": this.getMonth() + 1,
        "d+": this.getDate(),
        "H+": this.getHours(),
        "m+": this.getMinutes(),
        "s+": this.getSeconds()
    };
    if (/(y+)/.test(fmt))
        fmt = fmt.replace(RegExp.$1,
        (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt))
            fmt = fmt.replace(RegExp.$1,
            RegExp.$1.length == 1 ? o[k] :
            ("00" + o[k]).substr(("" + o[k]).length));
    return fmt;
};

var dateReviver = function (key,value){
    if(typeof value==="string"){
        var a=/^(\d{4})-(\d{2})-(\d{2})T/.exec(value);
        if(a){
            return new Date(value).format("yyyy-MM-dd");
        }
    }
    return value;
};

// =======================
// æŸ¥è©¢åŠŸèƒ½
// =======================
function bestdaylong_show(str){

    if(!str || str.trim()==""){
        alert("è«‹è¼¸å…¥é—œéµå­—");
        return;
    }

    var code = getAuthCode();
    if(!code) return;

    var get_url = GAS_URL +
        "?uid=" + encodeURIComponent(str) +
        "&code=" + encodeURIComponent(code);

    fetch(get_url)
    .then(res=>res.text())
    .then(text=>{

        var obj = JSON.parse(text,dateReviver);

        if(obj.auth===false){
            alert(obj.message);
            sessionStorage.removeItem("authCode");
            return;
        }

        if(obj.ok===false){
            alert(obj.message);
            return;
        }

        var html='<table border=1 width=100%>';

        for(var i=0;i<obj.length;i++){
            html+='<tr>';
            for(var j=0;j<obj[i].data.length;j++){
                html+='<td>'+obj[i].data[j]+'</td>';
            }
            html+='</tr>';
        }

        html+='</table>';

        document.getElementById("order_status").innerHTML=html;

        if(obj.length==1){
            alert("æŸ¥ç„¡è³‡æ–™");
        }

    })
    .catch(err=>{
        alert("ç³»çµ±é€£ç·šéŒ¯èª¤ï¼š"+err.message);
    });
}

</script>
</head>

<body>

<h3>å®¶é•·è³‡æ–™æŸ¥è©¢ç³»çµ±</h3>

é—œéµå­—ï¼š
<input type="text" id="uid"
 onkeydown="if(event.key==='Enter')bestdaylong_show(uid.value);" />

<input type="button" value="æŸ¥è©¢"
 onclick="bestdaylong_show(uid.value);" />

<hr>

<div id="order_status"></div>

</body>
</html>
