<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>家長資料查詢系統</title>

<style>
body { font-family: sans-serif; padding: 20px; }
table { border-collapse: collapse; margin-top: 10px; }
th, td { padding: 8px; border: 1px solid #ccc; }
#btnQuery { cursor: pointer; }
</style>

<script>

var GAS_URL = "https://script.google.com/macros/s/AKfycbwwPt4QXfhij0Vc2xnUXXhyeG_EHfjIO8CuvG-6wnCxcMztlCji8ONatc5JCsU6NkYv/exec";

// =====================
// 驗證碼
// =====================
function getAuthCode() {
  let code = sessionStorage.getItem("authCode");
  if (!code) {
    code = prompt("請輸入驗證碼：");
    if (!code) return null;
    sessionStorage.setItem("authCode", code);
  }
  return code;
}

// =====================
// 生日格式 YYYY/MM/DD
// =====================
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return y + "/" + m + "/" + day;
}

// =====================
// 查詢
// =====================
function bestdaylong_show(str) {

  document.getElementById("order_status").innerHTML = "";

  if (!str || str.trim()==="") {
    alert("請輸入關鍵字");
    return;
  }

  const code = getAuthCode();
  if (!code) return;

  const get_url = GAS_URL + "?uid=" +
                  encodeURIComponent(str) +
                  "&code=" +
                  encodeURIComponent(code);

  fetch(get_url)
  .then(r=>r.text())
  .then(text=>{

    let obj = JSON.parse(text);

    if (obj.auth===false) {
      alert(obj.message);
      sessionStorage.removeItem("authCode");
      return;
    }

    if (obj.ok===false) {
      alert(obj.message);
      return;
    }

    var html = '<table width="100%">';
    for (var i=0;i<obj.length;i++) {

      var tag = (i===0) ? "th" : "td";
      var bg = (i===0) ? ' style="background:#eee;"' : '';

      html += "<tr"+bg+">";

      for (var j=0;j<obj[i].data.length;j++) {

        let value = obj[i].data[j];

        // 第6欄生日
        if (j===5 && i!==0) {
          value = formatDate(value);
        }

        html += "<"+tag+">"+value+"</"+tag+">";
      }

      html += "</tr>";
    }

    html += "</table>";

    document.getElementById("order_status").innerHTML = html;

    if (obj.length<=1) {
      document.getElementById("order_status").innerHTML += "<p>查無資料</p>";
    }

  })
  .catch(err=>{
    alert("系統連線失敗："+err.message);
  });
}

window.addEventListener("DOMContentLoaded",function(){
  var input=document.getElementById("uid");
  input.addEventListener("keydown",function(e){
    if(e.key==="Enter") bestdaylong_show(input.value);
  });
});

</script>
</head>

<body>

<h3>家長資料查詢系統</h3>

關鍵字：
<input type="text" id="uid" placeholder="請輸入關鍵字" />

<input type="button"
       id="btnQuery"
       value="查詢"
       onclick="bestdaylong_show(document.getElementById('uid').value);" />

<hr/>
<div id="order_status"></div>

</body>
</html>
